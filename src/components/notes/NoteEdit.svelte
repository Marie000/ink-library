<script>
  import {note, notes, refreshNotes, page} from '../../stores'
  import NoteEditor from '../widgets/NoteEditor.svelte'
  import {getToken} from '../../getToken'
  import Button from '../widgets/Button.svelte'
  let title
  $: if ($notes && $notes.type !== "loading") {
    const listNote = $notes.items.find(item => item.shortId === $note.shortId)
    if (listNote && listNote.publication) {
      title = listNote.publication.name
    } else {
      title = `Workspace: ${$page.params.workspace}`
    }
  }
  let body = ""
  $: if ($note && $note.body && $note.body[0]) {
    body = $note.body[0].content
  }
  let text = ""
  function clean(obj) {
    for (var propName in obj) { 
      if (obj[propName] === null || obj[propName] === undefined) {
        delete obj[propName];
      }
    }
  }
  async function save () {
      try {
        const payload = Object.assign({}, $note)
        if (payload.body.length !== 0) {
          const body = payload.body.find(body => body.motivation === "commenting")
          body.content = text
          clean(body)
        } else {
          payload.body = [{ motivation: "commenting", content: text }]
        }
        await fetch(`/api/note/${$note.shortId}`, {
          method: "PUT",
          credentials: "include",
          body: JSON.stringify(payload),
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json",
            "csrf-token": getToken()
            }
        })
        $refreshNotes = Date.now()
      } catch (err) {
        console.error(err)
      }
  }
</script>

<style>
  /* your styles go here */
  .Item {
    min-height: calc(var(--base) * 4);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    margin: 2px;
    border-radius: 15px;
    font-size: var(--item-font-size);
    position: relative;
    transition: background-color 250ms cubic-bezier(0.075, 0.82, 0.165, 1), box-shadow 250ms cubic-bezier(0.075, 0.82, 0.165, 1), transform 250ms cubic-bezier(0.075, 0.82, 0.165, 1);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.05);
    background-color: #FAFAFA;
  }
  .title {
    font-size: var(--item-font-size);
    font-weight: 600;
    padding: calc(var(--base) * 0.5) 0;
    display: flex;
    flex-direction: column;
  }
  .Top {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    border-bottom: 0.5px solid var(--light);
    padding: calc(var(--base) * 0.5);
    align-items: center;
    background-color: white;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
  }
  .CardBottom {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    padding: calc(var(--base) * 0.5);
    align-items: center;
    height: calc(var(--base) * 2);
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 15px;
  }
  .CardMain {
    padding: 0 calc(var(--base) * 1);
    grid-gap: calc(var(--base) * 0.5);
    flex: 1 1 auto;
  }
  .Modified {
    text-align: right;
    color: #888;
    font-size: 0.75rem;
  }
  .Circle {
    width: 1rem;
    height: 1rem;
    border-radius: 100%;
    background-color:#FEA95B;
  }
  .Item :global(p) {
    font-size: calc(var(--reader-font-size) * 0.85);
  }
  
  :global(#sapper .Item .ql-toolbar.ql-snow), :global(#sapper .Item .ql-container.ql-snow) {
    border: none;
  }
</style>
{#if $note.type !== 'loading'}
<div class="Item">
  <div class="Top">
    <span class="Icon"><svg width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M11.0174 13C10.9514 13 10.8854 13 10.8194 13C10.8121 12.9935 10.7974 12.9805 10.7901 12.9805C10.482 12.9222 10.1813 12.8703 9.87323 12.8119C9.30846 12.7081 8.74369 12.6043 8.18626 12.5005C8.01023 12.4681 7.8342 12.4357 7.65817 12.4032C6.96871 12.2735 6.27926 12.1438 5.5898 12.014C4.89301 11.8843 4.18889 11.7546 3.4921 11.6249C2.91266 11.5211 2.33323 11.4238 1.76112 11.3005C1.50441 11.2486 1.21836 11.2616 0.990988 11.093C0.792953 10.9503 0.675599 10.7751 0.580249 10.5805C0.418887 10.2432 0.374879 9.88647 0.440891 9.52322C0.492233 9.23781 0.609587 8.97835 0.8663 8.79025C0.990988 8.69943 1.13768 8.6216 1.2697 8.53078C1.29171 8.51132 1.31371 8.46592 1.30638 8.43997C1.25504 8.31024 1.18169 8.187 1.13035 8.05727C1.02766 7.79781 1.01299 7.53186 1.057 7.26591C1.07167 7.14267 1.10834 7.02591 1.13035 6.89618C1.08634 6.88969 1.04233 6.87023 0.998323 6.87023C0.668264 6.87023 0.484899 6.67564 0.323537 6.46807C0.00814753 6.04644 -0.0578641 5.57941 0.0448207 5.09293C0.110832 4.75563 0.301533 4.48968 0.638926 4.30806C0.719607 4.26265 0.800288 4.23022 0.873634 4.18481C1.00566 4.10049 1.13035 4.00968 1.26237 3.92535C1.68778 3.6594 2.11319 3.39346 2.54593 3.134C2.61194 3.09508 2.68529 3.07562 2.7513 3.04318C2.76597 3.0367 2.78064 3.03021 2.78797 3.02372C2.83198 2.97832 2.87599 2.93291 2.92733 2.89399C3.1107 2.77724 3.29406 2.66697 3.48476 2.55669C3.55077 2.51778 3.63146 2.5048 3.69013 2.4594C3.80015 2.38804 3.88817 2.30372 3.99819 2.23885C4.35758 2.01183 4.72432 1.7848 5.09105 1.56426C5.44311 1.3502 5.79517 1.12966 6.14723 0.915604C6.57264 0.656143 6.99072 0.390195 7.41613 0.130734C7.4528 0.111274 7.49681 0.104788 7.53348 0.0983014C7.56282 0.0593822 7.59949 0.0269496 7.6435 0.00748999C7.68751 -0.00548306 7.73885 0.00100347 7.79019 0.00748999C8.0469 0.0464091 8.30362 0.0918148 8.56033 0.130734C9.11042 0.221545 9.66786 0.312357 10.218 0.396682C10.658 0.468033 11.0981 0.539385 11.5382 0.60425C12.0003 0.675602 12.455 0.75344 12.9171 0.824792C13.4379 0.909117 13.9586 0.986955 14.4794 1.07128C14.9121 1.14263 15.3449 1.2075 15.7776 1.27885C16.1003 1.33074 16.4231 1.38263 16.7384 1.43453C16.8485 1.45399 16.9145 1.51885 16.9291 1.61615C16.9438 1.72642 16.8925 1.79128 16.7971 1.84966C16.7311 1.88858 16.6504 1.95993 16.6504 2.01831C16.6358 2.43994 16.6431 2.85507 16.6431 3.28319C17.0172 3.34805 17.3839 3.40643 17.7506 3.46481C17.8826 3.49075 17.9487 3.54265 17.9633 3.6594C17.978 3.75022 17.912 3.87346 17.8166 3.90589C17.7066 3.94481 17.6846 4.00968 17.6846 4.10049C17.6846 4.54157 17.6846 4.98265 17.6846 5.41725C17.6846 5.45617 17.6846 5.49509 17.6919 5.53401C17.8313 5.5405 17.9267 5.5859 18 5.67671C18 5.73509 18 5.79347 18 5.85185C17.89 5.94266 17.8166 6.08536 17.6333 6.09185C17.6186 6.09185 17.5966 6.1178 17.5819 6.13726C17.5379 6.18915 17.5086 6.24753 17.4572 6.28645C17.3472 6.37726 17.2299 6.4551 17.1198 6.54591C17.0905 6.57185 17.0612 6.62375 17.0612 6.66266C17.0538 6.95456 17.0612 7.24645 17.0612 7.53835C17.0612 7.64213 17.0612 7.74591 17.0612 7.8497C17.0978 7.86267 17.1272 7.87565 17.1492 7.87565C17.2665 7.8951 17.3472 7.947 17.3766 8.05727C17.4059 8.16105 17.3472 8.22592 17.2739 8.2843C17.0392 8.45943 16.8118 8.64106 16.5771 8.81619C16.313 9.01079 16.049 9.1989 15.7849 9.39349C15.5942 9.53619 15.4109 9.68539 15.2275 9.82809C15.0148 9.99025 14.7874 10.1459 14.5747 10.3081C14.274 10.5351 13.988 10.7686 13.6872 11.0022C13.4012 11.2227 13.1151 11.4303 12.8291 11.6508C12.4477 11.9362 12.0663 12.2281 11.6849 12.5135C11.5749 12.5913 11.4502 12.6627 11.3402 12.7405C11.2228 12.8184 11.1274 12.9092 11.0174 13ZM1.40173 9.16646C1.40173 9.23781 1.40173 9.29619 1.40173 9.35457C1.40173 9.80214 1.40173 10.2432 1.40173 10.6908C1.40173 10.7557 1.4164 10.7816 1.50441 10.8011C1.87848 10.8659 2.24521 10.9373 2.61194 11.0022C3.09603 11.093 3.57278 11.1773 4.05686 11.2681C4.73899 11.3913 5.42111 11.5211 6.10323 11.6443C6.74134 11.7611 7.37945 11.8843 8.01756 12.0011C8.66301 12.1243 9.30846 12.2411 9.95391 12.3643C10.0786 12.3903 10.2033 12.4032 10.3133 12.4227C10.328 12.4032 10.328 12.4032 10.328 12.3968C10.328 11.8908 10.3353 11.3784 10.328 10.8724C10.328 10.853 10.2913 10.814 10.262 10.8076C9.77788 10.7103 9.29379 10.6194 8.80971 10.5286C8.01023 10.3794 7.21809 10.2367 6.41862 10.0876C6.29393 10.0616 6.16924 10.0357 6.04455 10.0162C5.91253 9.99025 5.78784 9.96431 5.65581 9.94485C5.53113 9.9189 5.40644 9.89944 5.27441 9.87998C5.14972 9.85403 5.02504 9.82809 4.90035 9.80863C4.76832 9.78268 4.64363 9.75674 4.51161 9.74376C4.39426 9.73079 4.29157 9.69187 4.17422 9.67241C3.53611 9.56214 2.89799 9.4389 2.25988 9.32214C1.97383 9.27025 1.70245 9.22484 1.40173 9.16646ZM9.9099 8.06375C9.9099 8.01835 9.9099 7.98592 9.9099 7.95348C9.9099 7.49943 9.9099 7.03888 9.9099 6.58483C9.9099 6.48753 9.8879 6.44861 9.77054 6.42915C9.08109 6.30591 1.15235 4.83346 0.983654 4.80103C0.983654 4.85292 0.983654 5.80644 0.983654 6.24104C0.983654 6.40969 0.983654 6.40969 1.17435 6.44212C1.87114 6.57834 9.7192 8.03132 9.9099 8.06375ZM10.9294 10.1005C10.9294 10.0616 10.9367 10.0357 10.9367 10.0162C10.9367 9.5362 10.9367 9.05619 10.9367 8.58268C10.9367 8.55024 10.9147 8.49835 10.8927 8.49187C10.8634 8.47889 10.8121 8.50484 10.7827 8.5243C10.68 8.6216 10.5627 8.66051 10.416 8.63457C9.97591 8.55024 9.53583 8.46592 9.09576 8.38808C8.61901 8.29727 8.13492 8.21294 7.65817 8.12213C7.40146 8.07673 7.14474 8.02483 6.88803 7.97943C6.3086 7.86916 5.73649 7.76537 5.15706 7.6551C4.35025 7.50591 3.55077 7.35672 2.74397 7.20753C2.51659 7.16213 2.28188 7.12321 2.04718 7.0778C2.04718 7.53835 2.04718 7.9924 2.04718 8.45943C4.9957 8.99781 7.95155 9.54917 10.9294 10.1005ZM11.8682 8.38808C11.7436 8.47241 11.6482 8.60862 11.4575 8.58916C11.4575 9.12106 11.4575 9.64647 11.4575 10.1848C11.4868 10.1719 11.5015 10.1719 11.5089 10.1589C11.6849 10.0292 16.9438 6.0659 17.0172 6.01401C17.0978 5.96212 17.1565 5.91671 17.1565 5.8259C17.1565 5.37833 17.1565 4.92428 17.1565 4.47671C17.1565 4.45725 17.1565 4.4313 17.1492 4.37941C17.0538 4.45725 16.9805 4.52211 16.8998 4.58049C16.6578 4.77509 12.0296 8.2843 11.8682 8.38808ZM10.4233 8.15457C10.438 8.15457 10.4453 8.15457 10.4527 8.15457C10.7387 7.94051 16.1223 3.86697 16.1223 3.80211C16.1223 3.36102 16.1223 2.91994 16.1223 2.48534C16.1223 2.4594 16.115 2.43345 16.115 2.40102C15.9976 2.47237 10.548 6.57185 10.4307 6.56537C10.4233 7.09078 10.4233 7.62267 10.4233 8.15457ZM10.8487 12.5459C10.9221 12.4876 10.9954 12.4292 11.0614 12.3773C11.4648 12.0724 16.203 8.47889 16.4231 8.33619C16.5184 8.27132 16.5404 8.21294 16.5404 8.11565C16.5331 7.92754 16.5404 7.73294 16.5404 7.54483C16.5404 7.36321 16.5404 7.18159 16.5404 6.9805C16.5037 6.99348 16.4744 6.99996 16.4597 7.01294C16.2984 7.13618 11.2888 10.7881 11.2888 10.7881C11.1348 10.8854 10.8707 10.9308 10.8487 10.9308C10.8487 11.4757 10.8487 12.014 10.8487 12.5459Z" fill="currentColor"/>
    </svg>
    </span> 
    <span class="title">{title}</span> 
    <Button click={save}>Save</Button>
  </div>
  <div class="CardMain">
   <NoteEditor html={body} bind:richtext={text}/>
  </div>
  <div class="CardBottom"><span></span>
   <span class="Modified"><strong>Modified:</strong>  {new Date($note.updated).toLocaleString(undefined, { year: 'numeric', month: 'numeric', day: 'numeric' })}</span>
  </div>
  </div>
{/if}